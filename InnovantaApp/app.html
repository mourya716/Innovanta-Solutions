<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovanta AI Dashboard - CEO Presentation Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <style>
        /* BASE & THEME */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d1117; /* GitHub/VS Code Dark background */
            color: #c9d1d9; /* High-contrast light text */
        }
        .navbar { background-color: #161b22; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); }
        
        /* CARDS & CONTAINERS */
        .dashboard-card { 
            background-color: #161b22; 
            border: 1px solid #30363d; /* Mid-gray border */
            border-radius: 12px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }
        .dashboard-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
            border-color: #58a6ff; /* Neon blue accent on hover */
        }

        /* KPI VISUALS */
        .stat-value { 
            color: #58a6ff; /* Neon Blue for Primary Metric */
            text-shadow: 0 0 5px rgba(88, 166, 255, 0.5); 
        }
        .kpi-wrapper { padding: 1.5rem; }
        .kpi-label { font-weight: 500; color: #8b949e; }
        
        /* ALERT & ROI Colors */
        .kpi-blue { border-left: 6px solid #58a6ff; }
        .kpi-green { border-left: 6px solid #3fb950; }
        .kpi-alert { 
            border-left: 6px solid #ff7b72; 
            background-color: #211c1c; /* Slightly redder background for alerts */
        }

        /* LOADER */
        .loader-spinner { 
            border-top-color: #58a6ff; 
            border-left-color: #58a6ff; 
            border-right-color: transparent;
            border-bottom-color: transparent;
        }

        /* LOGIN */
        #login-screen { 
            background-color: #161b22; 
            border: 1px solid #30363d; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        #login-screen input {
             background-color: #0d1117; 
             border-color: #30363d;
             color: #c9d1d9;
        }
        #login-screen button {
            background-image: linear-gradient(to right, #58a6ff, #4092e0);
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }

        /* AI RESULTS STYLING (The Report) */
        #ai-results h3 { 
            font-size: 1.6rem; 
            font-weight: 800; 
            margin-top: 2rem; 
            margin-bottom: 1rem; 
            color: #58a6ff; 
            border-bottom: 2px solid #30363d;
            padding-bottom: 0.75rem;
            text-shadow: 0 0 5px rgba(88, 166, 255, 0.2); 
        }
        #ai-results p { margin-bottom: 1rem; line-height: 1.6; color: #c9d1d9; }
        #ai-results li { 
            margin-bottom: 0.8rem; 
            padding: 1rem;
            background-color: #1f2937; /* Lighter shade for list items */
            border-radius: 8px;
            border-left: 4px solid #3fb950; /* Green highlight for insights */
            color: #f0f6fc;
        }
        #ai-results li::before {
            content: "\f058"; /* Font Awesome Circle Check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 1rem;
            color: #3fb950;
        }
        
        /* Critical Alert List Styling */
        #ai-results .alert-list li {
            border-left: 4px solid #f85149; /* Red highlight for alerts */
            color: #f85149; /* Red text for warning */
            background-color: #2b1f1f;
        }
        #ai-results .alert-list li::before {
            content: "\f071"; /* Font Awesome Warning icon */
            color: #f85149;
        }

        /* History List Styling */
        .history-item {
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        .history-item:hover {
            background-color: #1f2937;
            border-left: 4px solid #58a6ff;
        }
        
    </style>
</head>
<body class="min-h-screen">

    <!-- Navbar -->
    <header class="navbar sticky top-0 z-10">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center max-w-7xl">
            <div class="flex items-center space-x-3">
                <svg class="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                </svg>
                <span class="font-extrabold text-2xl text-white">INNOVANTA</span><span class="text-blue-400 text-sm mt-1 ml-1 font-light tracking-widest">AI CONTROL PANEL</span>
            </div>
            <div id="auth-buttons" class="space-x-2">
                <button id="logout-button" class="hidden text-sm text-gray-400 hover:text-white transition duration-200"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="container mx-auto px-4 py-10 max-w-7xl">

        <!-- Login Screen -->
        <section id="login-screen" class="max-w-md mx-auto p-10 rounded-xl shadow-2xl space-y-8 mt-20">
            <h2 class="text-4xl font-extrabold text-white text-center tracking-wide">SECURE ACCESS</h2>
            <p class="text-gray-400 text-center text-md border-b border-gray-700 pb-4">Innovanta Enterprise AI Login</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" id="username" name="username" required placeholder="ceo@innovanta.com" class="block w-full p-3 shadow-inner rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="password" name="password" required placeholder="********" class="block w-full p-3 shadow-inner rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full text-white font-extrabold text-lg py-3 px-4 rounded-lg shadow-xl transition duration-300 transform hover:scale-[1.01] hover:shadow-2xl">
                    <i class="fas fa-sign-in-alt mr-2"></i> UNLOCK DASHBOARD
                </button>
                <p id="login-error" class="text-center text-red-500 text-sm hidden font-semibold">Authentication Failed. Please check credentials.</p>
            </form>
        </section>

        <!-- Dashboard Screen -->
        <section id="dashboard-screen" class="hidden pt-4 grid lg:grid-cols-4 gap-6">
            
            <!-- Left Column: History Sidebar -->
            <div class="lg:col-span-1">
                <div class="dashboard-card p-6 sticky top-20">
                    <h2 class="text-xl font-extrabold text-white mb-4 flex items-center border-b border-gray-700 pb-3">
                        <i class="fas fa-history text-blue-400 mr-3"></i> Analysis History
                    </h2>
                    <div id="history-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center py-4">No history found. Upload a file to start.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Main Dashboard & Analysis -->
            <div class="lg:col-span-3">
                <h1 class="text-4xl font-extrabold text-white mb-8 border-b border-gray-700 pb-4 tracking-wider">ENTERPRISE ANALYTICS OVERVIEW</h1>

                <!-- Upload Area & Status (Data Consolidation) -->
                <div class="dashboard-card p-8 mb-8">
                    <h2 class="text-2xl font-extrabold text-white mb-4 flex items-center">
                        <i class="fas fa-upload text-blue-400 mr-4"></i> 1. Secure Data Ingestion & Analysis Trigger
                    </h2>
                    <p class="text-gray-400 mb-6">Upload raw CSV file (max 10MB) for immediate, fragmented data unification and deep intelligence processing.</p>
                    
                    <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                        <input type="file" id="csv-upload" accept=".csv" class="flex-1 w-full md:w-auto text-sm text-gray-200 border border-gray-600 rounded-lg cursor-pointer bg-gray-700 p-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition duration-300">
                        
                        <button id="analyze-button" class="bg-green-600 text-white font-extrabold text-lg py-3 px-8 rounded-lg shadow-xl hover:bg-green-700 transition duration-300 disabled:opacity-50 flex items-center justify-center transform hover:scale-[1.02] w-full md:w-auto" disabled>
                            <i class="fas fa-satellite-dish mr-2"></i> Launch AI Analysis
                        </button>
                    </div>
                    
                    <p id="upload-status" class="mt-4 text-sm text-gray-400">Awaiting secure data input...</p>
                </div>
                
                <!-- KPI Cards (Real-time Insights) -->
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- KPI 1 -->
                    <div class="dashboard-card kpi-wrapper kpi-blue">
                        <p class="text-sm kpi-label flex items-center"><i class="fas fa-chart-bar mr-2 text-blue-500"></i> Records Processed</p>
                        <p id="kpi-total" class="stat-value text-5xl font-extrabold mt-2">0</p>
                    </div>
                    <!-- KPI 2 -->
                    <div class="dashboard-card kpi-wrapper kpi-green">
                        <p class="text-sm kpi-label flex items-center"><i class="fas fa-percentage mr-2 text-green-500"></i> Projected ROI (Q+1)</p>
                        <p id="kpi-roi" class="stat-value text-5xl font-extrabold mt-2 text-green-500">--</p>
                    </div>
                    <!-- KPI 3 -->
                    <div class="dashboard-card kpi-wrapper kpi-alert">
                        <p class="text-sm kpi-label flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i> Critical Alerts</p>
                        <p id="kpi-alerts" class="stat-value text-5xl font-extrabold mt-2 text-red-500">0</p>
                    </div>
                </div>

                <!-- Detailed Analysis Panel -->
                <div class="dashboard-card p-8 mt-8">
                    <h2 class="text-3xl font-extrabold text-white mb-6 flex items-center">
                        <i class="fas fa-cogs text-purple-400 mr-4"></i> 2. Detailed AI Business Report
                    </h2>
                    
                    <!-- Loading State -->
                    <div id="loading-state" class="hidden text-center py-16 space-y-4">
                        <div class="loader-spinner animate-spin rounded-full w-20 h-20 border-8 border-t-transparent mx-auto"></div>
                        <p class="text-2xl font-bold text-blue-400">Processing Data... Establishing Cognitive Link...</p>
                        <p class="text-gray-400 text-lg">Innovanta AI is synthesizing insights, this takes approximately 10-20 seconds.</p>
                    </div>

                    <!-- Results Output -->
                    <div id="ai-results" class="space-y-4 min-h-52">
                        <p class="text-xl text-center text-gray-500 py-16">Upload a file to launch the **Innovanta AI Business Analyst**.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const API_KEY = ""; // Canvas will inject the key at runtime
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const USER_STORAGE_KEY = 'innovanta_current_user'; // Stores the current logged-in username
        const HISTORY_PREFIX = 'innovanta_history_'; // Prefix for user-specific history key

        // --- 2. DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        
        const csvUpload = document.getElementById('csv-upload');
        const analyzeButton = document.getElementById('analyze-button');
        const uploadStatus = document.getElementById('upload-status');
        const loadingState = document.getElementById('loading-state');
        const aiResults = document.getElementById('ai-results');
        const historyList = document.getElementById('history-list');

        const kpiTotal = document.getElementById('kpi-total');
        const kpiRoi = document.getElementById('kpi-roi');
        const kpiAlerts = document.getElementById('kpi-alerts');
        const roiCard = document.querySelector('.kpi-green');
        const alertsCard = document.querySelector('.kpi-alert');

        let fileData = null; 
        let isAnalyzing = false; 

        // --- 3. CORE FUNCTIONS ---

        function getCurrentUserKey() {
            const username = localStorage.getItem(USER_STORAGE_KEY);
            return username ? HISTORY_PREFIX + username : null;
        }

        function updateView(isLoggedIn) {
            loginScreen.classList.toggle('hidden', isLoggedIn);
            dashboardScreen.classList.toggle('hidden', !isLoggedIn);
            logoutButton.classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                loadHistory();
            }
        }
        
        // --- AUTH: Login Persistence ---
        function checkSession() {
            const username = localStorage.getItem(USER_STORAGE_KEY);
            if (username) {
                updateView(true);
            } else {
                updateView(false);
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Simulated Authentication: Success if both fields are not empty
            if (username && password) {
                localStorage.setItem(USER_STORAGE_KEY, username);
                loginError.classList.add('hidden');
                updateView(true);
            } else {
                loginError.textContent = "Please enter both username and password.";
                loginError.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', () => {
            // Remove current session identifier
            localStorage.removeItem(USER_STORAGE_KEY);
            
            // Clear current view data
            updateView(false);
            resetKpis();
            csvUpload.value = '';
            fileData = null;
            analyzeButton.disabled = true;
            uploadStatus.textContent = 'Awaiting secure data input...';
            aiResults.innerHTML = '<p class="text-xl text-center text-gray-500 py-16">Upload a file to launch the **Innovanta AI Business Analyst**.</p>';
            historyList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No history found. Upload a file to start.</p>';
        });


        // --- HISTORY FUNCTIONS ---
        function getHistory() {
            const userKey = getCurrentUserKey();
            if (!userKey) return [];
            
            const history = localStorage.getItem(userKey);
            return history ? JSON.parse(history) : [];
        }

        function saveHistory(newEntry) {
            const userKey = getCurrentUserKey();
            if (!userKey) return; // Should not happen if logged in
            
            const history = getHistory();
            history.unshift(newEntry); // Add new entry to the start
            localStorage.setItem(userKey, JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = getHistory();
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No history found. Upload a file to start.</p>';
                return;
            }

            history.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'history-item p-3 text-sm text-gray-300 rounded-lg transition duration-200 flex justify-between items-center';
                item.dataset.index = index;
                item.innerHTML = `
                    <div>
                        <p class="font-semibold truncate">${entry.fileName}</p>
                        <p class="text-xs text-gray-500">${entry.date}</p>
                    </div>
                    <i class="fas fa-eye text-blue-400 hover:text-blue-300 ml-2"></i>
                `;
                item.addEventListener('click', () => {
                    displayHistoryEntry(index);
                });
                historyList.appendChild(item);
            });
            
            // Display the most recent entry automatically
            displayHistoryEntry(0);
        }

        function displayHistoryEntry(index) {
            const history = getHistory();
            const entry = history[index];
            if (!entry) return;

            // Highlight active item
            document.querySelectorAll('.history-item').forEach((item, i) => {
                item.classList.toggle('bg-blue-900', i === index);
                item.classList.toggle('bg-opacity-50', i === index);
            });

            // Update KPIs and Results
            kpiTotal.textContent = entry.kpiTotal;
            kpiRoi.textContent = entry.kpiRoi;
            kpiAlerts.textContent = entry.kpiAlerts;
            aiResults.innerHTML = renderMarkdownFinal(entry.reportMarkdown);

            // Update KPI card colors based on loaded history data
            updateKpiCardColors(entry.kpiRoi, entry.kpiAlerts);
            
            uploadStatus.textContent = `Viewing history: ${entry.fileName} analyzed on ${entry.date}.`;

        }

        function updateKpiCardColors(roiValue, alertCount) {
            const roiPercent = parseFloat(roiValue);
            
            // ROI Color
            if (!isNaN(roiPercent)) {
                roiCard.classList.toggle('border-green-500', roiPercent >= 5);
                roiCard.classList.toggle('border-red-500', roiPercent < 5);
                kpiRoi.classList.toggle('text-green-500', roiPercent >= 5);
                kpiRoi.classList.toggle('text-red-500', roiPercent < 5);
            }
            
            // Alerts Color
            const alerts = parseInt(alertCount);
            alertsCard.classList.toggle('border-red-500', alerts > 2);
            alertsCard.classList.toggle('border-yellow-500', alerts > 0 && alerts <= 2);
            alertsCard.classList.toggle('border-green-500', alerts === 0);
            kpiAlerts.classList.toggle('text-red-500', alerts > 2);
            kpiAlerts.classList.toggle('text-yellow-500', alerts > 0 && alerts <= 2);
            kpiAlerts.classList.toggle('text-green-500', alerts === 0);
        }

        // Resets KPIs visually (used on logout)
        function resetKpis() {
            kpiTotal.textContent = '0';
            kpiRoi.textContent = '--';
            kpiAlerts.textContent = '0';
            roiCard.classList.remove('border-red-500'); 
            roiCard.classList.add('border-green-500');
            alertsCard.classList.remove('border-yellow-500');
            alertsCard.classList.add('border-red-500');
            kpiRoi.classList.remove('text-red-500');
            kpiRoi.classList.add('text-green-500');
            kpiAlerts.classList.remove('text-yellow-500');
            kpiAlerts.classList.add('text-red-500');
        }


        // --- FILE HANDLING & AI CALL ---

        csvUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    uploadStatus.textContent = 'Error: Please upload a valid CSV file.';
                    analyzeButton.disabled = true;
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    fileData = {
                        content: e.target.result,
                        name: file.name
                    };
                    uploadStatus.textContent = `File loaded: ${file.name}. Click 'Launch AI Analysis' to begin processing.`;
                    analyzeButton.disabled = false;
                };
                reader.onerror = () => {
                    uploadStatus.textContent = 'Error reading file.';
                    analyzeButton.disabled = true;
                };
                reader.readAsText(file);
            } else {
                uploadStatus.textContent = 'Awaiting secure data input...';
                analyzeButton.disabled = true;
                fileData = null;
            }
        });

        analyzeButton.addEventListener('click', async () => {
            if (!fileData || isAnalyzing) return;

            isAnalyzing = true;
            loadingState.classList.remove('hidden');
            aiResults.innerHTML = '';
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<div class="loader-spinner animate-spin rounded-full w-5 h-5 border-2 border-t-transparent inline-block mr-2"></div> AI Analyzing...';
            kpiTotal.textContent = '...';
            kpiRoi.textContent = '...';
            kpiAlerts.textContent = '...';

            const totalRecords = fileData.content.split('\n').length - 1; // Subtract header row

            // --- 4. GEMINI API LOGIC (Client-Side) ---
            const systemPrompt = `You are Innovanta AI, a world-class financial and operational analyst specializing in Small to Medium Enterprises (SMEs). 
                The user has provided a raw CSV file containing business data. 
                Your task is to provide a structured, actionable analysis of this data. 
                Output the response in clean, minimal markdown, ensuring all required sections are present.

                **Required Output Structure:**
                1. A brief 2-3 sentence **Summary of Data**.
                2. A list of 4-5 high-value, specific **Actionable Insights** (e.g., "* Increase marketing spend in Q3 on digital channels").
                3. A "Real-time Alerts" section indicating **Critical Alerts** (issues found, e.g., "* High Customer Churn Rate") or stating "No Critical Alerts Detected".
                4. A separate section for **Smart ROI Calculation/Forecast** providing a percentage (must be a number followed by '%'), a reason for the forecast, and a strategy to achieve it.
                `;

            const userQuery = `Analyze the following CSV data and provide the structured analysis required. 
                                CSV Data:\n\n${fileData.content}\n\n`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }], 
            };

            const apiUrl = API_URL;

            try {
                let response = null;
                const maxRetries = 3;
                let delay = 1000;
                
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (i === maxRetries - 1) {
                         throw new Error(`API failed after ${maxRetries} retries.`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
                
                const result = await response.json();
                const reportMarkdown = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not retrieve AI analysis.";
                
                // Extract KPIs before display
                const { roiValue, alertCount } = extractKpisFromMarkdown(reportMarkdown);

                // Save to history
                const date = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
                const historyEntry = {
                    fileName: fileData.name,
                    date: date,
                    kpiTotal: totalRecords,
                    kpiRoi: roiValue,
                    kpiAlerts: alertCount,
                    reportMarkdown: reportMarkdown,
                };
                saveHistory(historyEntry);

                // Display the new entry
                displayHistoryEntry(0);
                
            } catch (error) {
                aiResults.innerHTML = `<p class="text-red-500 text-center text-lg font-semibold py-16">CRITICAL ERROR: AI Engine Failure. ${error.message}</p>`;
                console.error("Gemini API Error:", error);
                
                kpiTotal.textContent = 'FAIL';
                kpiRoi.textContent = 'FAIL';
                kpiAlerts.textContent = 'FAIL';

            } finally {
                isAnalyzing = false;
                loadingState.classList.add('hidden');
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = '<i class="fas fa-satellite-dish mr-2"></i> Launch AI Analysis';
            }
        });
        
        function extractKpisFromMarkdown(markdownText) {
            const roiMatch = markdownText.match(/Smart ROI Calculation\/Forecast.*?:.*?(\-?\d+(\.\d+)?)%/i);
            const alertsContentMatch = markdownText.match(/Critical Alerts.*?:(.*?)Smart ROI Calculation/s); 
            
            let roiValue = 'N/A';
            let alertCount = 0;

            if (roiMatch && roiMatch[1]) {
                roiValue = `${parseFloat(roiMatch[1]).toFixed(2)}%`;
            }

            if (alertsContentMatch) {
                const alertsListContent = alertsContentMatch[1].trim();
                const alertLines = alertsListContent.split('\n').filter(line => line.trim().startsWith('*') || line.trim().startsWith('-'));
                alertCount = alertLines.length;
            }

            return { roiValue, alertCount };
        }


        // Parses and displays the AI output and updates KPIs
        function displayResults(markdownText, totalRecords) {
            
            // --- 5. MARKDOWN PROCESSING ---
            const { roiValue, alertCount } = extractKpisFromMarkdown(markdownText);
            let renderedHtml = markdownText;

            if (alertCount > 0) {
                 const alertsListContent = markdownText.match(/Critical Alerts.*?:(.*?)Smart ROI Calculation/s)[1].trim();
                 const alertsBlock = `<div class="alert-list">${renderMarkdownList(alertsListContent)}</div>`;
                 renderedHtml = renderedHtml.replace(markdownText.match(/Critical Alerts.*?:(.*?)Smart ROI Calculation/s)[0], `Critical Alerts:\n\n${alertsBlock}\n\nSmart ROI Calculation`);
            } else {
                 renderedHtml = renderedHtml.replace(/Critical Alerts.*?:(.*?)Smart ROI Calculation/s, `Critical Alerts:\n\n<p class="text-green-500 font-semibold mt-2">No Critical Alerts Detected. System Health: Optimal.</p>\n\nSmart ROI Calculation`);
            }
            
            // Final rendering of the main results text
            aiResults.innerHTML = renderMarkdownFinal(renderedHtml);

            // 3. Update KPIs
            kpiTotal.textContent = totalRecords;
            kpiRoi.textContent = roiValue;
            kpiAlerts.textContent = alertCount;
            updateKpiCardColors(roiValue, alertCount);
        }

        // Helper function for rendering lists
        function renderMarkdownList(markdown) {
            let html = "";
            const lines = markdown.split('\n').filter(line => line.trim().length > 0);
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('* ') || trimmed.startsWith('- ')) {
                    html += `<li>${trimmed.substring(2).trim()}</li>`;
                }
            });
            return `<ul>${html}</ul>`;
        }

        // Final Markdown Renderer 
        function renderMarkdownFinal(markdown) {
            let html = markdown;

            // 1. Convert H3 (text inside double asterisks **)
            html = html.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>');
            
            // 2. Process lists outside of the alert block
            html = html.replace(/<ul>(.*?)<\/ul>/gs, (match, p1) => {
                if (match.includes('class="alert-list"')) return match; 
                let listHtml = p1.replace(/[\*-]\s*(.*?)\n/g, '<li>$1</li>');
                return `<ul>${listHtml}</ul>`;
            });

            // 3. Simple line breaks to paragraphs
            html = html.replace(/(\r\n|\n|\r)/gm, ' ');
            html = html.replace(/<h3>/g, '\n\n<h3>');
            html = html.replace(/<\/h3>/g, '</h3>\n\n');
            html = html.replace(/(\s{2,})/g, ' ');
            html = html.replace(/\n\s*\n/g, '<p>'); // Convert multiple newlines to paragraphs

            return html;
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', checkSession);

    </script>
</body>
</html>
